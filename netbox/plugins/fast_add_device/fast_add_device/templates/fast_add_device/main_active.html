{% extends 'base/layout.html' %}

{% load form_helpers %}
{% load static %}
{% block content %}
<head>
  <meta charset="UTF-8">
  <title>{% block title %}{% endblock %}</title>
  <link rel="stylesheet" type="text/css" href="{% static 'netbox-print.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'netbox-light.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'netbox-external.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'netbox-dark.css' %}">
     <style>
        .myfield{
            border:1px solid #ccc;
            border-radius:5px;
            height:25px;
            width:200px;
            margin: 10px 10px 10px 0;
            color: white;
            background-color: #ccc;
        }
        .mybutton{
            padding: 12px 40px;
            border-radius: 8px;
            box-shadow: 2px 2px 2px 1px rgb(131, 131, 219) ;
            border: 1px solid gray;
            font-size: 20px;
            color: green;
        }
     </style>
</head>
<h2 class="offset-3">Fill in all forms for add ACTIVE device</h2>
<br>

    {% if response %}
       <p class="offset-3"> Device added successfully.</p>
    {% endif %}

    {% if form_errors %}
        {{ form_errors }}
    {% endif %}
    <form method="post">
        {% csrf_token %}

    <div class="offset-1">
        <table>
            <tr>
                <td align="left"><b>{{ form.ip_address.label_tag }}*</b></td>
                <td>{{ form.ip_address }}</td>
                <td>{{ form.managed_state.errors }}</td>
            </tr>
            <tr>
                <td align="left"><b>{{ form.platform.label_tag }}*</b></td>
                <td>{{ form.platform }}</td>
                <td>{{ form.managed_state.errors }}</td>
            </tr>
            <tr>
                <td align="left"><b>{{ form.device_role.label_tag }}*</b></td>
                <td>{{ form.device_role }}</td>
                <td>{{ form.managed_state.errors }}</td>
            </tr>
            <tr>
                <td align="left"><b>{{ form.tenants.label_tag }}*</b></td>
                <td>{{ form.tenants }}</td>
                <td>{{ form.managed_state.errors }}</td>
            </tr>
            <tr>
                <td align="left"><b>{{ form.site.label_tag }}*</b></td>
                <td>{{ form.site }}</td>
                <td>{{ form.managed_state.errors }}</td>
            </tr>
            <tr id="location-row" style="display: none;">
                <td align="left"><b>location:</b></td>
                <td align="right">
                    <select name="location" id="id_location">
                    </select>
                </td>
                <td id="location-errors"></td>
            </tr>
            <tr id="racks-row" style="display: none;">
                <td align="left"><b>racks:</b></td>
                <td align="right">
                    <select name="racks" id="id_racks">
                    </select>
                </td>
                <td id="racks-errors"></td>
            </tr>
            <tr>
                <td align="left"><b>{{ form.stack.label_tag }}*</b></td>
                <td>{{ form.stack }}</td>
                <td>{{ form.managed_state.errors }}</td>
            </tr>
            <tr>
                <td align="left"><b>{{ form.resource_group.label_tag }}*</b></td>
                <td>{{ form.resource_group }}</td>
                <td>{{ form.managed_state.errors }}</td>
            </tr>
            </table>
    </div>

<br>
        <button type="submit" class="mybutton offset-3">Create New Device</button>
    </form>
    <script>
            const siteSelect = document.querySelector('#id_site');
            const locationRow = document.querySelector('#location-row');
            const locationSelect = document.querySelector('#id_location');
            const racksSelect = document.querySelector('#id_racks');
            const locationErrors = document.querySelector('#location-errors');

            siteSelect.addEventListener('change', () => {
                const siteId = siteSelect.value;
                fetch(`/plugins/fast_add_device/get_location/?site_id=${siteId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.location.length > 0) {
                            locationRow.style.display = 'table-row';
                            locationRow.style.fontFamily = 'Arial, sans-serif';
                            locationSelect.innerHTML = '';
                            locationErrors.innerHTML = '';
                            data.location.forEach(location => {
                                const option = document.createElement('option');
                                option.value = location.id;
                                option.textContent = location.name;
                                locationSelect.appendChild(option);
                            });
                        } else {
                            locationRow.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error while getting data for location:', error);
                        locationRow.style.display = 'none';
                        locationErrors.innerHTML = 'Error loading locations';
                    });
            });
            locationSelect.addEventListener('change', () => {
                const selectedLocationId = locationSelect.value;
                document.querySelector('#id_location').value = selectedLocationId;
                console.log('selectedLocationId:', selectedLocationId);
                const url = `/plugins/fast_add_device/get_racks/?location_id=${selectedLocationId}`;
                console.log('Request URL:', url);
                fetch(`/plugins/fast_add_device/get_racks/?location_id=${selectedLocationId}`)
                    .then(response => response.json())
                    .then(data => {
                       if (data.racks.length > 0) {
                            racksRow.style.display = 'table-row';
                            racksRow.style.fontFamily = 'Arial, sans-serif';
                            racksSelect.innerHTML = '';
                            data.racks.forEach(racks => {
                                const option = document.createElement('option1');
                                option1.value = racks.id;
                                option1.textContent = racks.name;
                                racksSelect.appendChild(option1);
                            });

                       }   else {
                            racksRow.style.display = 'none';
                       }
                })
                     .catch(error => console.error('Error while getting data for racks:', error));
            });

    </script>



{% endblock %}






